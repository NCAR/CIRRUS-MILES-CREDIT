name: test PR

#workflow dispatch adds a button to run on github and is useful to always have there
on:
  #workflow_dispatch:
  pull_request:  # Use this to run the PR's workflow (usually for testing a new workflow)
  #pull_request_target:  # Use this to run main's cannonical workflow, to verify a PR
    types: [opened, synchronize, reopened]
jobs: 
  build: 
    runs-on: gha-runner-miles-credit
    container:
      image: docker.io/sgpearse/cirrustest:1.3.20.root.1
      options: --user 0
    steps: 
    - name: Debug permissions...
      run: |
        id
        ls -ld /__w /__w/_temp /__w/_temp/_runner_file_commands || true
        touch /__w/_temp/testfile || echo "Cannot write"
    - name: checkout code
      uses: actions/checkout@v4
      env:
        GITHUB_TOKEN: ${{ github.token }}
    - name: Fetch and checkout PR head commit
      run: |
        git config --global --add safe.directory /__w/CIRRUS-MILES-CREDIT/CIRRUS-MILES-CREDIT
        git fetch origin ${{ github.event.pull_request.head.sha }}
        git checkout ${{ github.event.pull_request.head.sha }}
    - name: Run debug job
      run: |
        echo "Running debug job for PR on self-hosted runner"
        chmod 777 credit.sh
        ./credit.sh
