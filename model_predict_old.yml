# --------------------------------------------------------------------------------------------------------------------- #
# This yaml file implements 6 hourly state-in-state-out crossformer
# on NSF NCAR HPCs (casper.ucar.edu and derecho.hpc.ucar.edu) 
# The model is trained on 6 hourly model-level ERA5 data with top solar irradiance, geopotential, and land-sea mask
# Output variables: model level [U, V, T, Q], single level [SP, t2m], and 500 hPa [U, V, T, Z, Q]
# --------------------------------------------------------------------------------------------------------------------- #
#save_loc: '/glade/work/dgagne/credit_arxiv_models/wxformer_1h/finetune_final/'
#save_loc: '/output'
#save_loc: '/glade/campaign/cisl/vast/credit_arxiv_models/wxformer_1h/finetune_final'
save_loc: '/checkpoint/finetune_final'
seed: 1000

data:
    # upper-air variables
    variables: ['U','V','T','Q']
    #save_loc: '/glade/derecho/scratch/dgagne/era5_zarr/y_TOTAL_2021*'
    #save_loc: '/glade/derecho/scratch/dgagne/gfs_init/*.zarr'
    save_loc: '/output/*.zarr'
    #save_loc: '/output'
    level_ids: [10, 30, 40, 50, 60, 70, 80, 90, 95, 100, 105, 110, 120, 130, 136, 137]    
    # surface variables
    surface_variables: ['SP','t2m','V500','U500','T500','Z500','Q500']
    #save_loc_surface: '/glade/derecho/scratch/dgagne/era5_zarr/y_TOTAL_2021*'
    #save_loc_surface: '/glade/derecho/scratch/dgagne/gfs_init/*.zarr'
    save_loc_surface: '/output/*.zarr'
    
    # dynamic forcing variables
    dynamic_forcing_variables: ['tsi']
    #save_loc_dynamic_forcing: '/glade/derecho/scratch/dgagne/credit_solar_nc_1h_0.25deg_20250418/solar_irradiance_2025-01-01_0000_2025-12-31_2300.nc'
    #save_loc_dynamic_forcing: '/glade/campaign/cisl/vast/save_loc_dynamic_forcing/solar_irradiance_2025-01-01_0000_2025-12-31_2300.nc'
    #save_loc_dynamic_forcing: '/glade/campaign/cisl/vast/pearse/save_loc_dynamic_forcing/solar_irradiance_2025-01-01_0000_2025-12-31_2300.nc'
    save_loc_dynamic_forcing: '/checkpoint/solar_irradiance_2025-01-01_0000_2025-12-31_2300.nc'
    
    # static variables
    static_variables: ['Z_GDS4_SFC','LSM']
    save_loc_static: '/glade/campaign/cisl/vast/pearse/static_scalers/gfs_static_norm.nc'

    # mean / std path
    mean_path: '/glade/campaign/cisl/vast/pearse/static_scalers/mean_1h_1979_2018_16lev_0.25deg.nc'
    std_path: '/glade/campaign/cisl/vast/pearse/static_scalers/std_residual_1h_1979_2018_16lev_0.25deg.nc'

    # train / validation split
    train_years: [1979, 2018]
    valid_years: [2018, 2019]
        
    # data workflow
    scaler_type: 'std_new'  
    
    history_len: 1
    valid_history_len: 1

    forecast_len: 0
    valid_forecast_len: 0
    
    # 1 for hourly model
    lead_time_periods: 1
    
    # do not use skip_period
    skip_periods: null
    
    # compatible with the old 'std'
    static_first: True
    
trainer:
    mode: none
    type: standard

model:
    # crossformer example
    type: "crossformer"
    frames: 1                         # number of input states (default: 1)
    image_height: &height 640                 # number of latitude grids (default: 640)
    image_width: &width 1280                 # number of longitude grids (default: 1280)
    levels: &levels 16                        # number of upper-air variable levels (default: 15)
    channels: 4                       # upper-air variable channels
    surface_channels: 7               # surface variable channels
    input_only_channels: 3            # dynamic forcing, forcing, static channels
    output_only_channels: 0           # diagnostic variable channels

    patch_width: 1                    # number of latitude grids in each 3D patch (default: 1)
    patch_height: 1                   # number of longitude grids in each 3D patch (default: 1)
    frame_patch_size: 1               # number of input states in each 3D patch (default: 1)

    dim: [128, 256, 512, 1024]        # Dimensionality of each layer
    depth: [2, 2, 8, 2]               # Depth of each layer
    global_window_size: [10, 5, 2, 1] # Global window size for each layer
    local_window_size: 10             # Local window size
    cross_embed_kernel_sizes:         # kernel sizes for cross-embedding
    - [4, 8, 16, 32]
    - [2, 4]
    - [2, 4]
    - [2, 4]
    cross_embed_strides: [2, 2, 2, 2] # Strides for cross-embedding (default: [4, 2, 2, 2])
    attn_dropout: 0.                  # Dropout probability for attention layers (default: 0.0)
    ff_dropout: 0.                    # Dropout probability for feed-forward layers (default: 0.0)

    interp: False

    # map boundary padding
    padding_conf:
        activate: True
        mode: earth
        pad_lon: 80             # number of grids to pad on 0 and 360 deg lon
        pad_lat: 80             # number of grids to pad on -90 and 90 deg lat
    
    post_conf:
        activate: True

        tracer_fixer:
            activate: True
            denorm: True
            tracer_name: ['Q', 'Q500']
            tracer_thres: [1e-8, 1e-8]

loss:
    use_latitude_weights: True  
    #latitude_weights: "/glade/u/home/wchapman/MLWPS/DataLoader/LSM_static_variables_ERA5_zhght.nc"
    latitude_weights: "/glade/campaign/cisl/vast/pearse/DataLoader/LSM_static_variables_ERA5_zhght.nc"
    

predict:
    mode: none
    forecasts:
        type: "custom"       # keep it as "custom"
        start_year: 2021     # year of the first initialization (where rollout will start)
        start_month: 2       # month of the first initialization
        start_day: 13         # day of the first initialization
        start_hours: [0] # hour-of-day for each initialization, 0 for 00Z, 12 for 12Z
        duration: 1         # number of days to initialize, starting from the (year, mon, day) above
                             # duration should be divisible by the number of GPUs
                             # (e.g., duration: 384 for 365-day rollout using 32 GPUs)
        days: 10             # forecast lead time as days (1 means 24-hour forecast)
    realtime:
        forecast_start_time: "2025-07-02 00:00:00"
        forecast_end_time: "2025-07-02 02:00:00"
        #forecast_end_time: "2025-07-12 00:00:00"
        forecast_timestep: "1h"
    interp_pressure:
        pressure_levels: [500.0, 700.0, 850.0]
        #height_levels: [0, 250.0, 500.0, 750.0, 
        #                1000.0, 1250.0, 1500.0, 1750.0, 
        #                2000.0, 2250.0, 2500.0, 2750.0,
        #                3000.0, 3250.0, 3500.0, 3750.0,
        #                4000.0, 4250.0, 4500.0, 4750.0,
        #                5000.0,
        #                ]
    ua_var_encoding:
        zlib: True
        complevel: 1
        shuffle: True
    #    chunksizes: [1, *levels, *height, *width]
        chunksizes: (1, *levels, *height, *width)

    pressure_var_encoding:
        zlib: True
        complevel: 1
        shuffle: True
    #    chunksizes: [ 1, 1, *height, *width]
        chunksizes: ( 1, 1, *height, *width)

    surface_var_encoding:
        zlib: true
        complevel: 1
        shuffle: True
        chunksizes: (1, *height, *width)
        #chunksizes: [1, *height, *width]
   #initial_condition_path: "/glade/derecho/scratch/pearse/gfs_init/"
    initial_condition_path: "/output"
    static_fields: "/glade/campaign/cisl/aiml/credit/static_scalers/gfs_static_whole.nc"
    #metadata: '/glade/u/home/dgagne/miles-credit/credit/metadata/era5.yaml'
    metadata: '/glade/campaign/cisl/vast/pearse/metadata/era5.yaml'
    #save_forecast: '/glade/derecho/scratch/pearse/CREDIT/RAW_OUTPUT/wxformer_1h_gfs_demo/'
    #save_forecast: '/output/wxformer_1h_gfs'
    save_forecast: '/output'

    # turn-off low-pass filter
    use_laplace_filter: False

